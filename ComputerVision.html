<!DOCTYPE HTML>
<html>

<head>
    <title>Generic - Phantom by HTML5 UP</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <noscript>
        <link rel="stylesheet" href="assets/css/noscript.css" />
    </noscript>
</head>

<body class="is-preload">
    <!-- Wrapper -->
    <div id="wrapper">


        <div id="main">
            <div class="inner">
                <h1>Computer Vision: Roundabout</h1>
                <span class="image main"><iframe width="620" height="415" src="https://www.youtube.com/embed/OkT1bzTeAdA?
                    autoplay=1&mute=1&controls=0&loop=1">
                    </iframe></span>

                <p>
                    android project development and design, This app is a collaborative recipe book
                    You can log in as a guest and be impressed by the app, but in order to upload recipes and give
                    comments and ratings, you must register and log in.
                </p>

                <!-- <div class="row-container">
                    <div class="first-row">
                    </div>
                    <iframe src="project roundabout/rou.html" class="second-row"></iframe>
                </div> -->

                <!--  -->


                <!--  -->


                <a href="https://github.com/Shay-M/Share-Recipe-book">
                    <img src="images/git.png" alt="Share-Recipe-book-github" style="width:50px;height:50px;">
                </a>


            </div>



            <div>

                <head>
                    <meta charset="utf-8" />
                    <meta name="generator" content="pandoc" />
                    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
                    <style>
                        body {
                            margin: 0 auto;
                            padding-left: 20px;
                            padding-right: 20px;
                            word-wrap: break-word;
                            text-rendering: optimizeLegibility;
                            font-kerning: normal;
                        }

                        @media (max-width: 600px) {
                            body {
                                font-size: 0.9em;
                                padding: 1em;
                            }
                        }

                        @media print {
                            body {
                                background-color: transparent;
                                color: black;
                                font-size: 12pt;
                            }

                            p,
                            h2,
                            h3 {
                                orphans: 3;
                                widows: 3;
                            }

                            h2,
                            h3,
                            h4 {
                                page-break-after: avoid;
                            }
                        }

                        p {
                            margin: 1em 0;
                        }

                        a {
                            color: #1a1a1a;
                        }

                        a:visited {
                            color: #1a1a1a;
                        }

                        img {
                            max-width: 100%;
                        }

                        h1,
                        h2,
                        h3,
                        h4,
                        h5,
                        h6 {
                            margin-top: 1.4em;
                        }

                        h5,
                        h6 {
                            font-size: 1em;
                            font-style: italic;
                        }

                        h6 {
                            font-weight: normal;
                        }

                        ol,
                        ul {
                            padding-left: 1.7em;
                            margin-top: 1em;
                        }

                        li>ol,
                        li>ul {
                            margin-top: 0;
                        }

                        blockquote {
                            margin: 1em 0 1em 1.7em;
                            padding-left: 1em;
                            border-left: 2px solid #e6e6e6;
                            color: #606060;
                        }

                        code {
                            font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
                            font-size: 85%;
                            margin: 0;
                        }

                        pre {
                            margin: 1em 0;
                            overflow: auto;
                        }

                        pre code {
                            padding: 0;
                            overflow: visible;
                        }

                        .sourceCode {
                            background-color: transparent;
                            overflow: visible;
                        }

                        hr {
                            background-color: #1a1a1a;
                            border: none;
                            height: 1px;
                            margin: 1em 0;
                        }

                        table {
                            margin: 1em 0;
                            border-collapse: collapse;
                            width: 100%;
                            overflow-x: auto;
                            display: block;
                            font-variant-numeric: lining-nums tabular-nums;
                        }

                        table caption {
                            margin-bottom: 0.75em;
                        }

                        tbody {
                            margin-top: 0.5em;
                            border-top: 1px solid #1a1a1a;
                            border-bottom: 1px solid #1a1a1a;
                        }

                        th {
                            border-top: 1px solid #1a1a1a;
                            padding: 0.25em 0.5em 0.25em 0.5em;
                        }

                        td {
                            padding: 0.125em 0.5em 0.25em 0.5em;
                        }

                        header {
                            margin-bottom: 4em;
                            text-align: center;
                        }

                        #TOC li {
                            list-style: none;
                        }

                        #TOC a:not(:hover) {
                            text-decoration: none;
                        }

                        code {
                            white-space: pre-wrap;
                        }

                        span.smallcaps {
                            font-variant: small-caps;
                        }

                        span.underline {
                            text-decoration: underline;
                        }

                        div.column {
                            display: inline-block;
                            vertical-align: top;
                            width: 50%;
                        }

                        div.hanging-indent {
                            margin-left: 1.5em;
                            text-indent: -1.5em;
                        }

                        ul.task-list {
                            list-style: none;
                        }

                        pre>code.sourceCode {
                            white-space: pre;
                            position: relative;
                        }

                        pre>code.sourceCode>span {
                            display: inline-block;
                            line-height: 1.25;
                        }

                        pre>code.sourceCode>span:empty {
                            height: 1.2em;
                        }

                        .sourceCode {
                            overflow: visible;
                        }

                        code.sourceCode>span {
                            color: inherit;
                            text-decoration: inherit;
                        }

                        div.sourceCode {
                            margin: 1em 0;
                        }

                        pre.sourceCode {
                            margin: 0;
                        }

                        @media screen {
                            div.sourceCode {
                                overflow: auto;
                            }
                        }

                        @media print {
                            pre>code.sourceCode {
                                white-space: pre-wrap;
                            }

                            pre>code.sourceCode>span {
                                text-indent: -5em;
                                padding-left: 5em;
                            }
                        }

                        pre.numberSource code {
                            counter-reset: source-line 0;
                        }

                        pre.numberSource code>span {
                            position: relative;
                            left: -4em;
                            counter-increment: source-line;
                        }

                        pre.numberSource code>span>a:first-child::before {
                            content: counter(source-line);
                            position: relative;
                            left: -1em;
                            text-align: right;
                            vertical-align: baseline;
                            border: none;
                            display: inline-block;
                            -webkit-touch-callout: none;
                            -webkit-user-select: none;
                            -khtml-user-select: none;
                            -moz-user-select: none;
                            -ms-user-select: none;
                            user-select: none;
                            padding: 0 4px;
                            width: 4em;
                            color: #aaaaaa;
                        }

                        pre.numberSource {
                            margin-left: 3em;
                            border-left: 1px solid #aaaaaa;
                            padding-left: 4px;
                        }

                        div.sourceCode {}

                        @media screen {
                            pre>code.sourceCode>span>a:first-child::before {
                                text-decoration: underline;
                            }
                        }

                        code span.al {
                            color: #ff0000;
                            font-weight: bold;
                        }

                        /* Alert */
                        code span.an {
                            color: #60a0b0;
                            font-weight: bold;
                            font-style: italic;
                        }

                        /* Annotation */
                        code span.at {
                            color: #7d9029;
                        }

                        /* Attribute */
                        code span.bn {
                            color: #40a070;
                        }

                        /* BaseN */
                        code span.bu {}

                        /* BuiltIn */
                        code span.cf {
                            color: #007020;
                            font-weight: bold;
                        }

                        /* ControlFlow */
                        code span.ch {
                            color: #4070a0;
                        }

                        /* Char */
                        code span.cn {
                            color: #880000;
                        }

                        /* Constant */
                        code span.co {
                            color: #60a0b0;
                            font-style: italic;
                        }

                        /* Comment */
                        code span.cv {
                            color: #60a0b0;
                            font-weight: bold;
                            font-style: italic;
                        }

                        /* CommentVar */
                        code span.do {
                            color: #ba2121;
                            font-style: italic;
                        }

                        /* Documentation */
                        code span.dt {
                            color: #902000;
                        }

                        /* DataType */
                        code span.dv {
                            color: #40a070;
                        }

                        /* DecVal */
                        code span.er {
                            color: #ff0000;
                            font-weight: bold;
                        }

                        /* Error */
                        code span.ex {}

                        /* Extension */
                        code span.fl {
                            color: #40a070;
                        }

                        /* Float */
                        code span.fu {
                            color: #06287e;
                        }

                        /* Function */
                        code span.im {}

                        /* Import */
                        code span.in {
                            color: #60a0b0;
                            font-weight: bold;
                            font-style: italic;
                        }

                        /* Information */
                        code span.kw {
                            color: #007020;
                            font-weight: bold;
                        }

                        /* Keyword */
                        code span.op {
                            color: #666666;
                        }

                        /* Operator */
                        code span.ot {
                            color: #007020;
                        }

                        /* Other */
                        code span.pp {
                            color: #bc7a00;
                        }

                        /* Preprocessor */
                        code span.sc {
                            color: #4070a0;
                        }

                        /* SpecialChar */
                        code span.ss {
                            color: #bb6688;
                        }

                        /* SpecialString */
                        code span.st {
                            color: #4070a0;
                        }

                        /* String */
                        code span.va {
                            color: #19177c;
                        }

                        /* Variable */
                        code span.vs {
                            color: #4070a0;
                        }

                        /* VerbatimString */
                        code span.wa {
                            color: #60a0b0;
                            font-weight: bold;
                            font-style: italic;
                        }

                        /* Warning */
                        .display.math {
                            display: block;
                            text-align: center;
                            margin: 0.5rem auto;
                        }
                    </style>
                    <!--[if lt IE 9]>
                      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
                    <![endif]-->
                </head>

                <body>
                    <section id="computer-vision-project-roundabout" class="cell markdown">
                        <h1>Computer Vision Project: Roundabout</h1>
                        <p>Submited By: <strong>Aaron Leviashvili</strong> and <strong>Shay Mualem</strong></p>
                    </section>
                    <div class="cell code" data-execution_count="1">
                        <div class="sourceCode" id="cb1">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
                  <span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
                  <span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
                  <span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
                  <span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cv2.__version__)</span>
                  <span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">&#39;image&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;gray&#39;</span>) <span class="co"># set the default color-map of plt.image() to &#39;gray&#39;</span></span>
                  <span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>plt.rc(<span class="st">&#39;figure&#39;</span>, figsize<span class="op">=</span>[<span class="dv">15</span>,<span class="dv">15</span>]) <span class="co"># set a bigger default figure size</span></span></code></pre>
                        </div>
                        <div class="output stream stdout">
                            <pre><code>4.5.0
                  </code></pre>
                        </div>
                    </div>
                    <section id="part-1-video-stabilization" class="cell markdown">
                        <h1>Part 1: Video Stabilization</h1>
                        <p>Main Algorithm: Calculating Optical flow between two frames and stabilizing the image against
                            the rotation of the image.</p>
                        <p>Pipeline is outlined in the following cells.</p>
                    </section>
                    <div class="cell code" data-execution_count="2">
                        <div class="sourceCode" id="cb3">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing capture of the video</span></span>
                  <span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>cap <span class="op">=</span> cv2.VideoCapture(<span class="st">&#39;P1_roundabout.mp4&#39;</span>)</span>
                  <span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for the stabilized output video</span></span>
                  <span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span>
                  <span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span>
                  <span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>FPS <span class="op">=</span> cap.get(cv2.CAP_PROP_FPS)</span>
                  <span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span><span class="st">&#39;mp4v&#39;</span>)</span>
                  <span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Zero Padding parameter</span></span>
                  <span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">300</span></span>
                  <span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> W <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>N</span>
                  <span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> H <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>N</span>
                  <span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing video writing </span></span>
                  <span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> cv2.VideoWriter(<span class="st">&#39;P1_roundabout_stabilized.mp4&#39;</span>,fourcc, FPS, (W,H))</span></code></pre>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="3">
                        <div class="sourceCode" id="cb4">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for corner detection</span></span>
                  <span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>feature_params <span class="op">=</span> <span class="bu">dict</span>( maxCorners <span class="op">=</span> <span class="dv">3000</span>,</span>
                  <span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                       qualityLevel <span class="op">=</span> <span class="fl">0.01</span>,</span>
                  <span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>                       minDistance <span class="op">=</span> <span class="dv">10</span>,</span>
                  <span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                       blockSize <span class="op">=</span> <span class="dv">5</span> )</span>
                  <span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for optical flow</span></span>
                  <span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>lk_params <span class="op">=</span> <span class="bu">dict</span>( winSize  <span class="op">=</span> (<span class="dv">10</span>,<span class="dv">10</span>),</span>
                  <span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                  maxLevel <span class="op">=</span> <span class="dv">5</span>,</span>
                  <span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                  criteria <span class="op">=</span> (cv2.TERM_CRITERIA_EPS <span class="op">|</span> cv2.TERM_CRITERIA_COUNT, <span class="dv">10</span>, <span class="fl">0.03</span>))</span></code></pre>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="4">
                        <div class="sourceCode" id="cb5">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ret, firstFrame <span class="op">=</span> cap.read()</span>
                  <span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># For demonstration puprposes we skip a few frames</span></span>
                  <span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">8</span>):</span>
                  <span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    ret, secondFrame <span class="op">=</span> cap.read()</span>
                  <span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>firstFrame <span class="op">=</span> cv2.copyMakeBorder(firstFrame, N, N, N, N, cv2.BORDER_CONSTANT)</span>
                  <span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>secondFrame <span class="op">=</span> cv2.copyMakeBorder(secondFrame, N, N, N, N, cv2.BORDER_CONSTANT)</span>
                  <span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>firstFrame_gray <span class="op">=</span> cv2.cvtColor(firstFrame, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>secondFrame_gray <span class="op">=</span> cv2.cvtColor(secondFrame, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Smoothing out the image for canny edge detector</span></span>
                  <span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>firstFrame_blur <span class="op">=</span> cv2.GaussianBlur(firstFrame_gray,(<span class="dv">0</span>,<span class="dv">0</span>),<span class="dv">2</span>)</span>
                  <span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Detecting the circles in the image</span></span>
                  <span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>firstFrame_circles <span class="op">=</span> cv2.HoughCircles(firstFrame_blur,method<span class="op">=</span>cv2.HOUGH_GRADIENT,dp<span class="op">=</span><span class="dv">1</span>,minDist<span class="op">=</span><span class="dv">40</span>,</span>
                  <span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                           param1<span class="op">=</span><span class="dv">100</span>,param2<span class="op">=</span><span class="dv">20</span>,minRadius<span class="op">=</span><span class="dv">340</span>,maxRadius<span class="op">=</span><span class="dv">345</span>)</span>
                  <span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Converting the resulting image from float32 type to int</span></span>
                  <span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>firstFrame_circles <span class="op">=</span> firstFrame_circles.astype(np.<span class="bu">int</span>)</span>
                  <span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Converting the image that was loaded in grayscale back to it&#39;s original RGB form</span></span>
                  <span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>firstFrame_rgb <span class="op">=</span> cv2.cvtColor(firstFrame_gray, cv2.COLOR_GRAY2RGB)</span>
                  <span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Drawing the detected circles over the image</span></span>
                  <span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (x,y,r) <span class="kw">in</span> firstFrame_circles[<span class="dv">0</span>]:</span>
                  <span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    cv2.circle(firstFrame_rgb,(x,y),r,(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">255</span>),<span class="dv">3</span>)</span>
                  <span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>plt.imshow(firstFrame_rgb)</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="4">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x177a5b2fbe0&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/dc284fab0cd0f2386d357515645b369cb5966562.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="5">
                        <div class="sourceCode" id="cb7">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the Image mask</span></span>
                  <span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>centerMask <span class="op">=</span> np.zeros(firstFrame.shape, dtype<span class="op">=</span>np.uint8)</span>
                  <span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (x,y,r) <span class="kw">in</span> firstFrame_circles[<span class="dv">0</span>]:</span>
                  <span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    cv2.circle(centerMask,(x,y),r,(<span class="dv">255</span>,<span class="dv">255</span>,<span class="dv">255</span>),<span class="op">-</span><span class="dv">1</span>)</span>
                  <span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    </span>
                  <span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>centerMask <span class="op">=</span> cv2.cvtColor(centerMask, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>plt.imshow(centerMask)</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="5">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x177a5c1dfd0&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/4fe61ed1a386ab3b2bc0c634460734d0b2674779.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="6">
                        <div class="sourceCode" id="cb9">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First We detect good features to track in the first frame</span></span>
                  <span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>firstFramePoints <span class="op">=</span> cv2.goodFeaturesToTrack(firstFrame_gray, mask <span class="op">=</span> centerMask, <span class="op">**</span>feature_params)</span>
                  <span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>plt.imshow(firstFrame_gray)</span>
                  <span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>plt.plot(firstFramePoints[:,<span class="dv">0</span>,<span class="dv">0</span>], firstFramePoints[:,<span class="dv">0</span>,<span class="dv">1</span>],<span class="st">&#39;.b&#39;</span>)</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="6">
                            <pre><code>[&lt;matplotlib.lines.Line2D at 0x177a85450d0&gt;]</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/2f79c86d5bbf1ce91ac6f5a1744494d3d76f36e9.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="7">
                        <div class="sourceCode" id="cb11">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we calculate optical flow of the points from the first frame to the second</span></span>
                  <span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>secondFramePoints, status, err <span class="op">=</span> cv2.calcOpticalFlowPyrLK(firstFrame_gray, secondFrame_gray, </span>
                  <span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                                                          firstFramePoints, <span class="va">None</span>, <span class="op">**</span>lk_params)</span>
                  <span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>canvas <span class="op">=</span> secondFrame.copy()</span>
                  <span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s draw the matches between the points</span></span>
                  <span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (p0,p1) <span class="kw">in</span> <span class="bu">zip</span>(firstFramePoints,secondFramePoints):</span>
                  <span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            x0,y0 <span class="op">=</span> p0.squeeze().astype(np.<span class="bu">int</span>)</span>
                  <span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            x1,y1 <span class="op">=</span> p1.squeeze().astype(np.<span class="bu">int</span>)</span>
                  <span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            canvas <span class="op">=</span> cv2.circle(canvas,(x0,y0),<span class="dv">7</span>,(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">255</span>),<span class="op">-</span><span class="dv">1</span>)</span>
                  <span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>            canvas <span class="op">=</span> cv2.line(canvas, (x0,y0),(x1,y1), (<span class="dv">0</span>,<span class="dv">255</span>,<span class="dv">255</span>), <span class="dv">2</span>) </span>
                  <span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>            canvas <span class="op">=</span> cv2.circle(canvas,(x1,y1),<span class="dv">7</span>,(<span class="dv">255</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="op">-</span><span class="dv">1</span>)</span>
                  <span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            </span>
                  <span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>plt.imshow(cv2.cvtColor(canvas,cv2.COLOR_BGR2RGB))</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="7">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x177a901d490&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/1a34bb63b3233cd40b98204a951bb4146345a2b5.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="8">
                        <div class="sourceCode" id="cb13">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># After we have the both sets of points we can calculate the transformation</span></span>
                  <span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>M, mask <span class="op">=</span> cv2.findHomography(secondFramePoints, firstFramePoints, cv2.RANSAC,<span class="fl">30.0</span>)</span>
                  <span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying the transformation to match the second frame to the first</span></span>
                  <span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>h,w <span class="op">=</span> firstFrame_gray.shape</span>
                  <span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>secondFrame_warp <span class="op">=</span> cv2.warpPerspective(secondFrame, M, (w,h))</span>
                  <span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Splicing the two images together</span></span>
                  <span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>splice <span class="op">=</span> cv2.addWeighted(secondFrame_warp,<span class="fl">0.5</span>,firstFrame,<span class="fl">0.5</span>,<span class="dv">0</span>)</span>
                  <span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">20</span>))</span>
                  <span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># We can observe in this image that scenery is matched correctly and the trajectory of the cars is smooth</span></span>
                  <span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>plt.imshow(cv2.cvtColor(splice,cv2.COLOR_BGR2RGB), cmap<span class="op">=</span><span class="st">&#39;gray&#39;</span>)</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="8">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x177a929deb0&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/04113aa3368565c8078b6806826df5bc95ae15b5.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="9">
                        <div class="sourceCode" id="cb15">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>cap <span class="op">=</span> cv2.VideoCapture(<span class="st">&#39;P1_roundabout.mp4&#39;</span>)</span>
                  <span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span>
                  <span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span>
                  <span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>FPS <span class="op">=</span> cap.get(cv2.CAP_PROP_FPS)</span>
                  <span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span><span class="st">&#39;mp4v&#39;</span>)</span>
                  <span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Zero Padding parameter</span></span>
                  <span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">300</span></span>
                  <span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> W <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>N</span>
                  <span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> H <span class="op">+</span> <span class="dv">2</span><span class="op">*</span>N</span>
                  <span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing video writing </span></span>
                  <span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> cv2.VideoWriter(<span class="st">&#39;P1_roundabout_stabilized.mp4&#39;</span>,fourcc, FPS, (W,H))</span>
                  <span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for detecting initial tracking features (corners)</span></span>
                  <span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>feature_params <span class="op">=</span> <span class="bu">dict</span>( maxCorners <span class="op">=</span> <span class="dv">3000</span>,</span>
                  <span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>                       qualityLevel <span class="op">=</span> <span class="fl">0.01</span>,</span>
                  <span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>                       minDistance <span class="op">=</span> <span class="dv">10</span>,</span>
                  <span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>                       blockSize <span class="op">=</span> <span class="dv">5</span> )</span>
                  <span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for Optical Flow</span></span>
                  <span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>lk_params <span class="op">=</span> <span class="bu">dict</span>( winSize  <span class="op">=</span> (<span class="dv">10</span>,<span class="dv">10</span>),</span>
                  <span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>                  maxLevel <span class="op">=</span> <span class="dv">5</span>,</span>
                  <span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>                  criteria <span class="op">=</span> (cv2.TERM_CRITERIA_EPS <span class="op">|</span> cv2.TERM_CRITERIA_COUNT, <span class="dv">10</span>, <span class="fl">0.03</span>))</span>
                  <span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Taking the first frame and finding good points to track in it</span></span>
                  <span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>ret, F0 <span class="op">=</span> cap.read()</span>
                  <span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>F0 <span class="op">=</span> cv2.copyMakeBorder(F0, N, N, N, N, cv2.BORDER_CONSTANT)</span>
                  <span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>F0_gray <span class="op">=</span> cv2.cvtColor(F0, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>pts0 <span class="op">=</span> cv2.goodFeaturesToTrack(F0_gray, mask <span class="op">=</span> centerMask, <span class="op">**</span>feature_params)</span>
                  <span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>out.write(F0)</span>
                  <span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>ret,F1 <span class="op">=</span> cap.read()</span>
                  <span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>F1 <span class="op">=</span> cv2.copyMakeBorder(F1, N, N, N, N, cv2.BORDER_CONSTANT)</span>
                  <span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>F1_gray <span class="op">=</span> cv2.cvtColor(F1, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>pts1, status, err <span class="op">=</span> cv2.calcOpticalFlowPyrLK(F0_gray, F1_gray, pts0, <span class="va">None</span>, <span class="op">**</span>lk_params)</span>
                  <span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>M, mask <span class="op">=</span> cv2.findHomography(pts1, pts0, cv2.RANSAC,<span class="fl">30.0</span>)</span>
                  <span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>h,w <span class="op">=</span> F0_gray.shape</span>
                  <span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>F1_warp <span class="op">=</span> cv2.warpPerspective(F1, M, (w,h))</span>
                  <span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>out.write(F1_warp)</span>
                  <span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> ret:</span>
                  <span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
                  <span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>        ret,F2 <span class="op">=</span> cap.read()</span>
                  <span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>        F2 <span class="op">=</span> cv2.copyMakeBorder(F2, N, N, N, N, cv2.BORDER_CONSTANT)</span>
                  <span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ret<span class="op">==</span><span class="va">True</span>:</span>
                  <span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>            F2_gray <span class="op">=</span> cv2.cvtColor(F2, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculating Optical Flow</span></span>
                  <span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>            pts2, status, err <span class="op">=</span> cv2.calcOpticalFlowPyrLK(F1_gray, F2_gray, pts1, <span class="va">None</span>, <span class="op">**</span>lk_params)</span>
                  <span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>            M, mask <span class="op">=</span> cv2.findHomography(pts2, pts0, cv2.RANSAC,<span class="fl">30.0</span>)</span>
                  <span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>            h,w <span class="op">=</span> F0_gray.shape</span>
                  <span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>            F2_warp <span class="op">=</span> cv2.warpPerspective(F2, M, (w,h))</span>
                  <span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ret<span class="op">==</span><span class="va">True</span>:</span>
                  <span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>            cv2.imshow(<span class="st">&#39;WINDOW_NAME&#39;</span>, F2_warp)</span>
                  <span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>            out.write(F2_warp)</span>
                  <span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (cv2.waitKey(<span class="dv">1</span>) <span class="op">&amp;</span> <span class="bn">0xff</span> <span class="op">==</span> <span class="dv">27</span>): <span class="co"># ESC key pressed?</span></span>
                  <span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
                  <span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>            F1 <span class="op">=</span> F2</span>
                  <span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>            F1_gray <span class="op">=</span> F2_gray</span>
                  <span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>            pts1 <span class="op">=</span> pts2</span>
                  <span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
                  <span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
                  <span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>cap.release() <span class="co"># release input video</span></span>
                  <span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>out.release() <span class="co"># release output video </span></span>
                  <span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>cv2.destroyAllWindows() <span class="co"># delete output window</span></span>
                  <span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>cv2.waitKey(<span class="dv">1</span>)<span class="op">;</span></span></code></pre>
                        </div>
                    </div>
                    <section id="part-2-vehicle-tracking" class="cell markdown">
                        <h1>Part 2: Vehicle Tracking</h1>
                        <p>First the vehicles are isolated from the background using absolute frame difference (After
                            Stabilization the vehicles are the only moving thing in the video.)</p>
                        <p>Then the black and white Images are used as mask for Shi-Tomasi GoodFeaturesToTrack and
                            keypoints are detected only on the vehicles themselves.</p>
                        <p>Pipeline is outlined in the following cells.</p>
                    </section>
                    <div class="cell code" data-execution_count="10">
                        <div class="sourceCode" id="cb16">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up the parameters for the two algorithms</span></span>
                  <span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Parametrs for detecting initial tracking features (corners)</span></span>
                  <span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>feature_params <span class="op">=</span> <span class="bu">dict</span>( maxCorners <span class="op">=</span> <span class="dv">10</span>,</span>
                  <span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                       qualityLevel <span class="op">=</span> <span class="fl">0.09</span>,</span>
                  <span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                       minDistance <span class="op">=</span> <span class="dv">10</span>,</span>
                  <span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                       blockSize <span class="op">=</span> <span class="dv">5</span> )</span>
                  <span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for Optical Flow</span></span>
                  <span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>lk_params <span class="op">=</span> <span class="bu">dict</span>( winSize  <span class="op">=</span> (<span class="dv">10</span>,<span class="dv">10</span>),</span>
                  <span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>                  maxLevel <span class="op">=</span> <span class="dv">5</span>,</span>
                  <span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>                  criteria <span class="op">=</span> (cv2.TERM_CRITERIA_EPS <span class="op">|</span> cv2.TERM_CRITERIA_COUNT, <span class="dv">10</span>, <span class="fl">0.03</span>))</span></code></pre>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="11">
                        <div class="sourceCode" id="cb17">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the capture</span></span>
                  <span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>cap <span class="op">=</span> cv2.VideoCapture(<span class="st">&#39;P1_roundabout_stabilized.mp4&#39;</span>)</span>
                  <span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing VIdeo Writing</span></span>
                  <span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span>
                  <span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span>
                  <span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>FPS <span class="op">=</span> cap.get(cv2.CAP_PROP_FPS)</span>
                  <span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span><span class="st">&#39;mp4v&#39;</span>)</span>
                  <span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing video writing </span></span>
                  <span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> cv2.VideoWriter(<span class="st">&#39;P1_roundabout_stabilized_With_Vehicle_Tracking.mp4&#39;</span>,fourcc, FPS, (W,H))</span></code></pre>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="12">
                        <div class="sourceCode" id="cb18">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Taking the first two frames from the video</span></span>
                  <span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ret, F0 <span class="op">=</span> cap.read()</span>
                  <span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>ret, F1 <span class="op">=</span> cap.read()</span>
                  <span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>F0_gray <span class="op">=</span> cv2.cvtColor(F0, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>F1_gray <span class="op">=</span> cv2.cvtColor(F1, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating absolute difference between the two frames</span></span>
                  <span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>FirstFrameDiff <span class="op">=</span> cv2.absdiff(F0_gray,F1_gray)</span>
                  <span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>plt.imshow(FirstFrameDiff)</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="12">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x177a9570760&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/c3bd3b96783dbf6de7bb21377c08a9715836e722.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="13">
                        <div class="sourceCode" id="cb20">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Blurring the Image and thresholding to get the outlines of the moving cars</span></span>
                  <span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>FirstBlur <span class="op">=</span> cv2.GaussianBlur(FirstFrameDiff, (<span class="dv">5</span>,<span class="dv">5</span>), <span class="dv">0</span>)</span>
                  <span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>_, FirstThresh <span class="op">=</span> cv2.threshold(FirstBlur, <span class="dv">50</span>, <span class="dv">255</span>, cv2.THRESH_BINARY)</span>
                  <span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>plt.imshow(FirstThresh)</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="13">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x1779f834c40&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/401d0145e8ed7acef221c315edede04d8bcc211e.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="14">
                        <div class="sourceCode" id="cb22">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying morphology to enhance the contours of the cars, the goal is to cover the car as much as possible</span></span>
                  <span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>kernel <span class="op">=</span> np.ones((<span class="dv">5</span>,<span class="dv">5</span>),np.uint8)</span>
                  <span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>dilate <span class="op">=</span> cv2.dilate(FirstThresh, kernel, iterations<span class="op">=</span><span class="dv">2</span>)</span>
                  <span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>closing <span class="op">=</span> cv2.morphologyEx(dilate, cv2.MORPH_CLOSE, kernel, iterations <span class="op">=</span> <span class="dv">10</span>)</span>
                  <span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>contour_mask <span class="op">=</span> cv2.dilate(closing, <span class="va">None</span>, iterations<span class="op">=</span><span class="dv">3</span>)</span>
                  <span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>plt.imshow(contour_mask)</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="14">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x1779f894790&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/25cbf95349a580123223d2fee6d071105c5d73ae.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="15">
                        <div class="sourceCode" id="cb24">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In order to drown out the white frame outlines caused by frame rotation a mask is created</span></span>
                  <span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Thresholded frame outline (A white square)</span></span>
                  <span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>_, FrameOutlines <span class="op">=</span> cv2.threshold(F1_gray, <span class="dv">1</span>, <span class="dv">255</span>, cv2.THRESH_BINARY)</span>
                  <span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The white square is minimized to fit the frame and exclude the white rotation lines</span></span>
                  <span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>kernel <span class="op">=</span> np.ones((<span class="dv">5</span>, <span class="dv">5</span>), np.uint8)</span>
                  <span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>FrameOutlines <span class="op">=</span> cv2.dilate(FrameOutlines, kernel)</span>
                  <span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>FrameOutlines_eroded <span class="op">=</span> cv2.erode(FrameOutlines,kernel)</span>
                  <span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>FrameOutlines_eroded_demo <span class="op">=</span> cv2.erode(FrameOutlines,kernel)</span>
                  <span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">50</span>): <span class="co"># Here erosion is exaggerated for demonstration purposes</span></span>
                  <span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    FrameOutlines_eroded_demo <span class="op">=</span> cv2.erode(FrameOutlines_eroded_demo,kernel)</span>
                  <span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>): <span class="co"># This is enough to drown out the noise</span></span>
                  <span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    FrameOutlines_eroded <span class="op">=</span> cv2.erode(FrameOutlines_eroded,kernel)</span>
                  <span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>outlinesCleared <span class="op">=</span> cv2.bitwise_and(FrameOutlines_eroded, F1_gray)</span>
                  <span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">1</span>)</span>
                  <span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>plt.imshow(FrameOutlines)</span>
                  <span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>)</span>
                  <span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>plt.imshow(FrameOutlines_eroded_demo)</span>
                  <span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>)</span>
                  <span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>plt.imshow(F1_gray)</span>
                  <span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>plt.subplot(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">4</span>)</span>
                  <span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>plt.imshow(outlinesCleared)</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="15">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x177ab0e1130&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/2a05182c99d40aed4f687863ee5aab3422cfca4e.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="16">
                        <div class="sourceCode" id="cb26">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Applied on the contour_mask</span></span>
                  <span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>contour_mask <span class="op">=</span> cv2.bitwise_and(contour_mask, FrameOutlines_eroded)</span>
                  <span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>plt.imshow(contour_mask)</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="16">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x1779f385cd0&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/7242d3a7fcd9d64d74d13d975843709189c208f6.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="17">
                        <div class="sourceCode" id="cb28">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Finding contours in the first image</span></span>
                  <span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>Contours, _ <span class="op">=</span> cv2.findContours(contour_mask, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)</span>
                  <span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>idLabelMask <span class="op">=</span> cv2.cvtColor(contour_mask,cv2.COLOR_GRAY2BGR)</span>
                  <span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Information about the Cars</span></span>
                  <span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>cars <span class="op">=</span> [] <span class="co"># Contains list of keypoints (Features of a car), color and ID number</span></span>
                  <span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>idCounter <span class="op">=</span> <span class="dv">0</span> <span class="co"># How many unique ID&#39;s so far have been given</span></span>
                  <span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Everything we need for vizualizing the tracking</span></span>
                  <span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>canvas <span class="op">=</span> np.zeros_like(F0)</span>
                  <span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>idBoxOffset <span class="op">=</span> <span class="dv">10</span></span>
                  <span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>idBoxSize <span class="op">=</span> <span class="dv">65</span></span>
                  <span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Treating each contour as a car, filtering the keypoints and giving it ID</span></span>
                  <span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ctrIdx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(Contours)):</span>
                  <span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cv2.contourArea(Contours[ctrIdx]) <span class="op">&gt;</span> <span class="dv">1400</span>:</span>
                  <span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        idCounter <span class="op">+=</span> <span class="dv">1</span></span>
                  <span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        ID <span class="op">=</span> idCounter <span class="co"># Assigning unique ID to the car</span></span>
                  <span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> (random.randint(<span class="dv">0</span>, <span class="dv">255</span>), random.randint(<span class="dv">0</span>, <span class="dv">255</span>), random.randint(<span class="dv">0</span>, <span class="dv">255</span>)) <span class="co"># Generating Random tracking color</span></span>
                  <span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Detecting features of the car</span></span>
                  <span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        oneCarMask <span class="op">=</span> np.zeros_like(contour_mask)</span>
                  <span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        oneCarMask <span class="op">=</span> cv2.drawContours(oneCarMask, Contours, ctrIdx, (<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>), <span class="op">-</span><span class="dv">1</span>)</span>
                  <span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        carFeatures <span class="op">=</span> cv2.goodFeaturesToTrack(F0_gray, mask <span class="op">=</span> oneCarMask, <span class="op">**</span>feature_params)</span>
                  <span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Appending the data to the cars list</span></span>
                  <span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        cars.append([ID,color,carFeatures])</span>
                  <span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculating the median point to draw the ID square (median is better, average might drift)</span></span>
                  <span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>        med <span class="op">=</span> np.median(carFeatures, axis<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
                  <span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>        cx <span class="op">=</span> <span class="bu">int</span>(med[<span class="dv">0</span>])</span>
                  <span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>        cy <span class="op">=</span> <span class="bu">int</span>(med[<span class="dv">1</span>])</span>
                  <span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Drawing the ID square and the points on the ID label canvas</span></span>
                  <span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>        pts <span class="op">=</span> np.int32([ [cx <span class="op">+</span> idBoxOffset,cy <span class="op">-</span> idBoxSize],[cx <span class="op">+</span> idBoxSize <span class="op">+</span> <span class="dv">50</span>,cy <span class="op">-</span> idBoxSize],</span>
                  <span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>                        [cx <span class="op">+</span> idBoxSize <span class="op">+</span> <span class="dv">50</span>,cy <span class="op">-</span> idBoxOffset],[cx <span class="op">+</span> idBoxOffset,cy <span class="op">-</span> idBoxOffset] ]).reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
                  <span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>        idLabelCanvas <span class="op">=</span> cv2.polylines(canvas,[pts],<span class="va">True</span>,(<span class="dv">255</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dv">2</span>, cv2.LINE_AA)</span>
                  <span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>        idLabelCanvas <span class="op">=</span> cv2.fillPoly(canvas,[pts],(<span class="dv">255</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
                  <span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p0 <span class="kw">in</span> carFeatures:</span>
                  <span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>            x0,y0 <span class="op">=</span> p0.squeeze().astype(np.<span class="bu">int</span>)</span>
                  <span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>            canvas <span class="op">=</span> cv2.circle(canvas,(x0,y0),<span class="dv">8</span>,color,<span class="op">-</span><span class="dv">1</span>) <span class="co"># new points</span></span>
                  <span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        canvas <span class="op">=</span> cv2.putText(canvas,<span class="st">&#39;ID: &#39;</span> <span class="op">+</span> <span class="bu">str</span>(ID), org <span class="op">=</span> (cx <span class="op">+</span> <span class="dv">20</span>, cy <span class="op">-</span> <span class="dv">20</span>),</span>
                  <span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>                    fontFace <span class="op">=</span> cv2.FONT_HERSHEY_PLAIN, fontScale <span class="op">=</span> <span class="dv">2</span>, color <span class="op">=</span> (<span class="dv">0</span>,<span class="dv">255</span>,<span class="dv">255</span>), thickness <span class="op">=</span> <span class="dv">3</span>,lineType <span class="op">=</span> <span class="dv">1</span>)</span>
                  <span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>plt.imshow(cv2.cvtColor(canvas,cv2.COLOR_BGR2RGB))</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="17">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x177ae04a130&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/30d585af2e54a6efccdd9dd04dc794fa6c946ff5.png" />
                            </p>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="18">
                        <div class="sourceCode" id="cb30">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>F0_gray <span class="op">=</span> F1_gray</span>
                  <span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Fast Forward a few frames and now try to find the same cars</span></span>
                  <span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
                  <span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    ret,F1 <span class="op">=</span> cap.read()</span>
                  <span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>F1_gray <span class="op">=</span> cv2.cvtColor(F1, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Frame Difference and morphology</span></span>
                  <span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>FrameDiff <span class="op">=</span> cv2.absdiff(F0_gray,F1_gray)</span>
                  <span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>Blur <span class="op">=</span> cv2.GaussianBlur(FrameDiff, (<span class="dv">5</span>,<span class="dv">5</span>), <span class="dv">0</span>)</span>
                  <span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>_, Thresh <span class="op">=</span> cv2.threshold(Blur, <span class="dv">50</span>, <span class="dv">255</span>, cv2.THRESH_BINARY)</span>
                  <span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>kernel <span class="op">=</span> np.ones((<span class="dv">5</span>,<span class="dv">5</span>),np.uint8)</span>
                  <span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>dilate <span class="op">=</span> cv2.dilate(Thresh, kernel, iterations<span class="op">=</span><span class="dv">2</span>)</span>
                  <span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>closing <span class="op">=</span> cv2.morphologyEx(dilate, cv2.MORPH_CLOSE, kernel, iterations <span class="op">=</span> <span class="dv">10</span>)</span>
                  <span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>contour_mask <span class="op">=</span> cv2.dilate(closing, <span class="va">None</span>, iterations<span class="op">=</span><span class="dv">3</span>)</span>
                  <span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co"># This mask allows us to drown out the frame rotation noise so we can focus only on the cars themselves.</span></span>
                  <span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>_, carMask <span class="op">=</span> cv2.threshold(F1_gray, <span class="dv">1</span>, <span class="dv">255</span>, cv2.THRESH_BINARY)</span>
                  <span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>kernel <span class="op">=</span> np.ones((<span class="dv">5</span>, <span class="dv">5</span>), np.uint8)</span>
                  <span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>carMask <span class="op">=</span> cv2.dilate(carMask, kernel)</span>
                  <span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
                  <span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    carMask <span class="op">=</span> cv2.erode(carMask,kernel)</span>
                  <span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    </span>
                  <span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>contour_mask <span class="op">=</span> cv2.bitwise_and(contour_mask, carMask)</span>
                  <span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Converting contour mask to color for demo purposes (Not part of the algorithm)</span></span>
                  <span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>contour_mask <span class="op">=</span> cv2.cvtColor(contour_mask,cv2.COLOR_GRAY2BGR)</span>
                  <span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(cars)):</span>
                  <span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        oldPoints <span class="op">=</span> cars[i][<span class="dv">2</span>]</span>
                  <span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        trackingColor <span class="op">=</span> cars[i][<span class="dv">1</span>]</span>
                  <span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        ID <span class="op">=</span> cars[i][<span class="dv">0</span>]</span>
                  <span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        newPoints, status, err <span class="op">=</span> cv2.calcOpticalFlowPyrLK(F0_gray, F1_gray, oldPoints, <span class="va">None</span>, <span class="op">**</span>lk_params)</span>
                  <span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    </span>
                  <span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculating the median point to draw the ID square (median is better, average might drift)</span></span>
                  <span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>        med <span class="op">=</span> np.median(newPoints, axis<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
                  <span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        cx <span class="op">=</span> <span class="bu">int</span>(med[<span class="dv">0</span>])</span>
                  <span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        cy <span class="op">=</span> <span class="bu">int</span>(med[<span class="dv">1</span>])</span>
                  <span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Deleting the points that are outside the frame outlines or that get stuck somewhere</span></span>
                  <span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p1,stat <span class="kw">in</span> <span class="bu">zip</span>(newPoints,status):</span>
                  <span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>            x1,y1 <span class="op">=</span> p1.squeeze().astype(np.<span class="bu">int</span>)</span>
                  <span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span>(np.absolute(x1 <span class="op">-</span> cx) <span class="op">&gt;</span> <span class="dv">50</span> <span class="kw">or</span> np.absolute(y1 <span class="op">-</span> cy) <span class="op">&gt;</span> <span class="dv">50</span>):</span>
                  <span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>                stat[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">0</span></span>
                  <span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
                  <span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>                x1,y1 <span class="op">=</span> p1.squeeze().astype(np.<span class="bu">int</span>)</span>
                  <span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>                contour_mask <span class="op">=</span> cv2.circle(contour_mask,(x1,y1),<span class="dv">8</span>,trackingColor,<span class="op">-</span><span class="dv">1</span>) <span class="co"># new points</span></span>
                  <span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Removing irrelevant points</span></span>
                  <span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>        newPoints <span class="op">=</span> newPoints[status[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>]</span>
                  <span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Drawing the ID square on the ID label canvas</span></span>
                  <span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>        pts <span class="op">=</span> np.int32([ [cx <span class="op">+</span> idBoxOffset,cy <span class="op">-</span> idBoxSize],[cx <span class="op">+</span> idBoxSize <span class="op">+</span> <span class="dv">50</span>,cy <span class="op">-</span> idBoxSize],</span>
                  <span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>                        [cx <span class="op">+</span> idBoxSize <span class="op">+</span> <span class="dv">50</span>,cy <span class="op">-</span> idBoxOffset],</span>
                  <span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>                        [cx <span class="op">+</span> idBoxOffset,cy <span class="op">-</span> idBoxOffset] ]).reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
                  <span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>        contour_mask <span class="op">=</span> cv2.polylines(contour_mask,[pts],<span class="va">True</span>,(<span class="dv">255</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dv">2</span>, cv2.LINE_AA)</span>
                  <span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>        contour_mask <span class="op">=</span> cv2.fillPoly(contour_mask,[pts],(<span class="dv">255</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
                  <span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>        contour_mask<span class="op">=</span> cv2.putText(contour_mask,<span class="st">&#39;ID: &#39;</span> <span class="op">+</span> <span class="bu">str</span>(ID), org <span class="op">=</span> (cx <span class="op">+</span> <span class="dv">20</span>, cy <span class="op">-</span> <span class="dv">20</span>),</span>
                  <span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>                    fontFace <span class="op">=</span> cv2.FONT_HERSHEY_PLAIN, fontScale <span class="op">=</span> <span class="dv">2</span>, color <span class="op">=</span> (<span class="dv">0</span>,<span class="dv">255</span>,<span class="dv">255</span>), thickness <span class="op">=</span> <span class="dv">3</span>,lineType <span class="op">=</span> <span class="dv">1</span>)</span>
                  <span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>plt.imshow(cv2.cvtColor(contour_mask,cv2.COLOR_BGR2RGB))</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="18">
                            <pre><code>&lt;matplotlib.image.AxesImage at 0x177a9d34af0&gt;</code></pre>
                        </div>
                        <div class="output display_data">
                            <p><img
                                    src="vertopal_3173856aa95b43a687f6d6e198fb9180/fb03524d14e140bb2a6179da95544edb6fdea6ae.png" />
                            </p>
                        </div>
                    </div>
                    <section id="the-final-tracking-algorithm-running-on-video" class="cell markdown">
                        <h1>The final tracking algorithm running on video:</h1>
                        <p>First cell is the setup using the first two frames, second cell analyzes the rest of the
                            video.</p>
                    </section>
                    <div class="cell code" data-execution_count="19">
                        <div class="sourceCode" id="cb32">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting up the parameters for the two algorithms</span></span>
                  <span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Params for corner detection</span></span>
                  <span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>feature_params <span class="op">=</span> <span class="bu">dict</span>( maxCorners <span class="op">=</span> <span class="dv">10</span>,</span>
                  <span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                       qualityLevel <span class="op">=</span> <span class="fl">0.09</span>,</span>
                  <span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                       minDistance <span class="op">=</span> <span class="dv">10</span>,</span>
                  <span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>                       blockSize <span class="op">=</span> <span class="dv">5</span> )</span>
                  <span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameters for optical flow</span></span>
                  <span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>lk_params <span class="op">=</span> <span class="bu">dict</span>( winSize  <span class="op">=</span> (<span class="dv">10</span>,<span class="dv">10</span>),</span>
                  <span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>                  maxLevel <span class="op">=</span> <span class="dv">5</span>,</span>
                  <span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                  criteria <span class="op">=</span> (cv2.TERM_CRITERIA_EPS <span class="op">|</span> cv2.TERM_CRITERIA_COUNT, <span class="dv">10</span>, <span class="fl">0.03</span>))</span>
                  <span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing the capture</span></span>
                  <span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>cap <span class="op">=</span> cv2.VideoCapture(<span class="st">&#39;P1_roundabout_stabilized.mp4&#39;</span>)</span>
                  <span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Initializing VIdeo Writing</span></span>
                  <span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>W <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_WIDTH))</span>
                  <span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>H <span class="op">=</span> <span class="bu">int</span>(cap.get(cv2.CAP_PROP_FRAME_HEIGHT))</span>
                  <span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>FPS <span class="op">=</span> cap.get(cv2.CAP_PROP_FPS)</span>
                  <span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>fourcc <span class="op">=</span> cv2.VideoWriter_fourcc(<span class="op">*</span><span class="st">&#39;mp4v&#39;</span>)</span>
                  <span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>out <span class="op">=</span> cv2.VideoWriter(<span class="st">&#39;P1_roundabout_stabilized_With_Vehicle_Tracking.mp4&#39;</span>,fourcc, FPS, (W,H))</span>
                  <span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Capturing the first two frames and converting their color to gray</span></span>
                  <span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>ret, F0 <span class="op">=</span> cap.read()</span>
                  <span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>ret, F1 <span class="op">=</span> cap.read()</span>
                  <span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>F0_gray <span class="op">=</span> cv2.cvtColor(F0, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>F1_gray <span class="op">=</span> cv2.cvtColor(F1, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a><span class="co"># This mask allows us to drown out the frame rotation noise so we can focus only on the cars themselves.</span></span>
                  <span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>_, carMask <span class="op">=</span> cv2.threshold(F1_gray, <span class="dv">1</span>, <span class="dv">255</span>, cv2.THRESH_BINARY) <span class="co"># We get a white rectangle in the middle.</span></span>
                  <span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>kernel <span class="op">=</span> np.ones((<span class="dv">5</span>, <span class="dv">5</span>), np.uint8)</span>
                  <span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>carMask <span class="op">=</span> cv2.dilate(carMask, kernel) <span class="co"># Dilation will remove any small imperfections in the rectangle so they don&#39;t compound.</span></span>
                  <span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
                  <span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>    carMask <span class="op">=</span> cv2.erode(carMask,kernel) <span class="co"># Erosion of the mask with a few passes allows us to make the rectangle smaller</span></span>
                  <span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating absolute difference between the frames to locate moving objects</span></span>
                  <span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>FirstFrameDiff <span class="op">=</span> cv2.absdiff(F0_gray,F1_gray)</span>
                  <span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Preparing the frame difference image to be processed</span></span>
                  <span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>FirstBlur <span class="op">=</span> cv2.GaussianBlur(FirstFrameDiff, (<span class="dv">5</span>,<span class="dv">5</span>), <span class="dv">0</span>)</span>
                  <span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>_, FirstThresh <span class="op">=</span> cv2.threshold(FirstBlur, <span class="dv">50</span>, <span class="dv">255</span>, cv2.THRESH_BINARY)</span>
                  <span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying morphology to bring out the contours of moving objects even more</span></span>
                  <span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>kernel <span class="op">=</span> cv2.getStructuringElement(cv2.MORPH_ELLIPSE,(<span class="dv">5</span>,<span class="dv">5</span>))</span>
                  <span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>dilate <span class="op">=</span> cv2.dilate(FirstThresh, kernel, iterations<span class="op">=</span><span class="dv">2</span>)</span>
                  <span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>closing <span class="op">=</span> cv2.morphologyEx(dilate, cv2.MORPH_CLOSE, kernel, iterations <span class="op">=</span> <span class="dv">10</span>)</span>
                  <span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>contour_mask <span class="op">=</span> cv2.dilate(closing, kernel, iterations<span class="op">=</span><span class="dv">3</span>)</span>
                  <span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Drowning out frame rotation noise</span></span>
                  <span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>contour_mask <span class="op">=</span> cv2.bitwise_and(contour_mask, carMask)</span>
                  <span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Once the contour_mask contains only moving cars we can proceed to detect them</span></span>
                  <span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>Contours, _ <span class="op">=</span> cv2.findContours(contour_mask, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)</span>
                  <span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Information about the Cars</span></span>
                  <span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>cars <span class="op">=</span> [] <span class="co"># will be a list of car objects, each car will have keypoints (Features of a car), color and ID number</span></span>
                  <span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>idCounter <span class="op">=</span> <span class="dv">0</span> <span class="co"># Keeping track of unique ID&#39;s given</span></span>
                  <span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Everything we need for vizualizing </span></span>
                  <span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>trackingPointCanvas <span class="op">=</span> np.zeros_like(F0)</span>
                  <span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>idLabelCanvas <span class="op">=</span> np.zeros_like(F0)</span>
                  <span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>idBoxOffset <span class="op">=</span> <span class="dv">10</span></span>
                  <span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>idBoxSize <span class="op">=</span> <span class="dv">65</span></span>
                  <span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Treating each contour as a car</span></span>
                  <span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ctrIdx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(Contours)):</span>
                  <span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cv2.contourArea(Contours[ctrIdx]) <span class="op">&gt;</span> <span class="dv">1400</span>:</span>
                  <span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>        idCounter <span class="op">+=</span> <span class="dv">1</span></span>
                  <span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>        ID <span class="op">=</span> idCounter <span class="co"># Assigning unique ID to the car</span></span>
                  <span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> (random.randint(<span class="dv">0</span>, <span class="dv">255</span>), random.randint(<span class="dv">0</span>, <span class="dv">255</span>), random.randint(<span class="dv">0</span>, <span class="dv">255</span>)) <span class="co"># Generating Random tracking color</span></span>
                  <span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Detecting features of the car</span></span>
                  <span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>        oneCarMask <span class="op">=</span> np.zeros_like(contour_mask)</span>
                  <span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>        oneCarMask <span class="op">=</span> cv2.drawContours(oneCarMask, Contours, ctrIdx, (<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>), <span class="op">-</span><span class="dv">1</span>)</span>
                  <span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>        carFeatures <span class="op">=</span> cv2.goodFeaturesToTrack(F0_gray, mask <span class="op">=</span> oneCarMask, <span class="op">**</span>feature_params)</span>
                  <span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Appending the data to the cars list</span></span>
                  <span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>        cars.append([ID,color,carFeatures])</span>
                  <span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculating the median point to draw the ID square (median is better, average might drift)</span></span>
                  <span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>        med <span class="op">=</span> np.median(newPoints, axis<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
                  <span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a>        cx <span class="op">=</span> <span class="bu">int</span>(med[<span class="dv">0</span>])</span>
                  <span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>        cy <span class="op">=</span> <span class="bu">int</span>(med[<span class="dv">1</span>])</span>
                  <span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Drawing the ID square on the ID label canvas</span></span>
                  <span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>        pts <span class="op">=</span> np.int32([ [cx <span class="op">+</span> idBoxOffset,cy <span class="op">-</span> idBoxSize],[cx <span class="op">+</span> idBoxSize <span class="op">+</span> <span class="dv">50</span>,cy <span class="op">-</span> idBoxSize],</span>
                  <span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a>                        [cx <span class="op">+</span> idBoxSize <span class="op">+</span> <span class="dv">50</span>,cy <span class="op">-</span> idBoxOffset],[cx <span class="op">+</span> idBoxOffset,cy <span class="op">-</span> idBoxOffset] ]).reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
                  <span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>        idLabelCanvas <span class="op">=</span> cv2.polylines(idLabelCanvas,[pts],<span class="va">True</span>,(<span class="dv">255</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dv">2</span>, cv2.LINE_AA)</span>
                  <span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>        idLabelCanvas <span class="op">=</span> cv2.fillPoly(idLabelCanvas,[pts],(<span class="dv">255</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
                  <span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>        canvas2idLabelCanvas<span class="op">=</span> cv2.putText(idLabelCanvas,<span class="st">&#39;ID: &#39;</span> <span class="op">+</span> <span class="bu">str</span>(ID), org <span class="op">=</span> (cx <span class="op">+</span> <span class="dv">20</span>, cy <span class="op">-</span> <span class="dv">20</span>),</span>
                  <span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>                    fontFace <span class="op">=</span> cv2.FONT_HERSHEY_PLAIN, fontScale <span class="op">=</span> <span class="dv">2</span>, color <span class="op">=</span> (<span class="dv">0</span>,<span class="dv">255</span>,<span class="dv">255</span>), thickness <span class="op">=</span> <span class="dv">3</span>,lineType <span class="op">=</span> <span class="dv">1</span>)</span></code></pre>
                        </div>
                    </div>
                    <div class="cell code" data-execution_count="20">
                        <div class="sourceCode" id="cb33">
                            <pre
                                class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>F0_gray <span class="op">=</span> F1_gray</span>
                  <span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span>(<span class="dv">1</span>):</span>
                  <span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    ret,F1 <span class="op">=</span> cap.read()</span>
                  <span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    </span>
                  <span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ret<span class="op">==</span><span class="va">True</span>:</span>
                  <span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        F1_gray <span class="op">=</span> cv2.cvtColor(F1, cv2.COLOR_BGR2GRAY)</span>
                  <span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>        idLabelCanvas <span class="op">=</span> np.zeros_like(F1)</span>
                  <span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    </span>
                  <span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># This mask allows us to drown out the frame rotation noise so we can focus only on the cars themselves.</span></span>
                  <span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>        _, carMask <span class="op">=</span> cv2.threshold(F1_gray, <span class="dv">1</span>, <span class="dv">255</span>, cv2.THRESH_BINARY)</span>
                  <span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> np.ones((<span class="dv">5</span>, <span class="dv">5</span>), np.uint8)</span>
                  <span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>        carMask <span class="op">=</span> cv2.dilate(carMask, kernel)</span>
                  <span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        pointFade <span class="op">=</span> carMask.copy()</span>
                  <span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
                  <span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>            carMask <span class="op">=</span> cv2.erode(carMask,kernel)</span>
                  <span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i<span class="op">%</span><span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>:</span>
                  <span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>                pointFade <span class="op">=</span> cv2.erode(pointFade,kernel)</span>
                  <span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculating using frame difference the new contours of the cars</span></span>
                  <span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        FrameDiff <span class="op">=</span> cv2.absdiff(F0_gray,F1_gray)</span>
                  <span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        Blur <span class="op">=</span> cv2.GaussianBlur(FrameDiff, (<span class="dv">5</span>,<span class="dv">5</span>), <span class="dv">0</span>)</span>
                  <span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        _, Thresh <span class="op">=</span> cv2.threshold(Blur, <span class="dv">50</span>, <span class="dv">255</span>, cv2.THRESH_BINARY)</span>
                  <span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>        kernel <span class="op">=</span> cv2.getStructuringElement(cv2.MORPH_ELLIPSE,(<span class="dv">5</span>,<span class="dv">5</span>))</span>
                  <span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>        dilate <span class="op">=</span> cv2.dilate(Thresh, kernel, iterations<span class="op">=</span><span class="dv">1</span>)</span>
                  <span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        closing <span class="op">=</span> cv2.morphologyEx(dilate, cv2.MORPH_CLOSE, kernel, iterations <span class="op">=</span> <span class="dv">10</span>)</span>
                  <span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        contour_mask <span class="op">=</span> cv2.dilate(closing, kernel, iterations<span class="op">=</span><span class="dv">3</span>)</span>
                  <span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>        contour_mask <span class="op">=</span> cv2.bitwise_and(contour_mask, carMask)        </span>
                  <span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>        i <span class="op">=</span> <span class="dv">0</span></span>
                  <span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Tracking each car</span></span>
                  <span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(cars):</span>
                  <span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>            oldPoints <span class="op">=</span> cars[i][<span class="dv">2</span>]</span>
                  <span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a>            trackingColor <span class="op">=</span> cars[i][<span class="dv">1</span>]</span>
                  <span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a>            ID <span class="op">=</span> cars[i][<span class="dv">0</span>]</span>
                  <span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a>            newPoints, status, err <span class="op">=</span> cv2.calcOpticalFlowPyrLK(F0_gray, F1_gray, oldPoints, <span class="va">None</span>, <span class="op">**</span>lk_params)</span>
                  <span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a>            </span>
                  <span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculating the median point to draw the ID square (median is better, average might drift)</span></span>
                  <span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a>            med <span class="op">=</span> np.median(newPoints, axis<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
                  <span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a>            cx <span class="op">=</span> <span class="bu">int</span>(med[<span class="dv">0</span>])</span>
                  <span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a>            cy <span class="op">=</span> <span class="bu">int</span>(med[<span class="dv">1</span>])</span>
                  <span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p1,stat <span class="kw">in</span> <span class="bu">zip</span>(newPoints,status):</span>
                  <span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a>                x1,y1 <span class="op">=</span> p1.squeeze().astype(np.<span class="bu">int</span>)</span>
                  <span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a>                </span>
                  <span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Deleting the points that are outside the frame outlines or that get stuck somewhere</span></span>
                  <span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span>(np.absolute(x1 <span class="op">-</span> cx) <span class="op">&gt;</span> <span class="dv">50</span> <span class="kw">or</span> np.absolute(y1 <span class="op">-</span> cy) <span class="op">&gt;</span> <span class="dv">50</span> <span class="kw">or</span> x1 <span class="op">&gt;</span> W <span class="kw">or</span> y1 <span class="op">&gt;</span> H <span class="kw">or</span></span>
                  <span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>                   pointFade[y1][x1] <span class="op">==</span> <span class="dv">0</span>):</span>
                  <span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>                    stat[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">0</span></span>
                  <span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
                  <span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>                    contour_mask <span class="op">=</span> cv2.circle(contour_mask, (x1,y1),<span class="dv">120</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>) <span class="co"># Erasing the car from detection</span></span>
                  <span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>            </span>
                  <span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Updating the points that are still left</span></span>
                  <span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>            newPoints <span class="op">=</span> newPoints[status[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>]</span>
                  <span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(newPoints) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
                  <span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>                cars.remove(cars[i])</span>
                  <span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
                  <span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>                cars[i][<span class="dv">2</span>] <span class="op">=</span> newPoints</span>
                  <span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>                i <span class="op">+=</span> <span class="dv">1</span></span>
                  <span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Drawing a tracking circle for the car</span></span>
                  <span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>                trackingPointCanvas <span class="op">=</span> cv2.circle(trackingPointCanvas,(cx,cy),<span class="dv">18</span>,trackingColor,<span class="op">-</span><span class="dv">1</span>)</span>
                  <span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Drawing the ID square on the ID label canvas</span></span>
                  <span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>                pts <span class="op">=</span> np.int32([ [cx <span class="op">+</span> idBoxOffset,cy <span class="op">-</span> idBoxSize],[cx <span class="op">+</span> idBoxSize <span class="op">+</span> <span class="dv">50</span>,cy <span class="op">-</span> idBoxSize],</span>
                  <span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>                                [cx <span class="op">+</span> idBoxSize <span class="op">+</span> <span class="dv">50</span>,cy <span class="op">-</span> idBoxOffset],</span>
                  <span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>                                [cx <span class="op">+</span> idBoxOffset,cy <span class="op">-</span> idBoxOffset] ]).reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
                  <span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a>                idLabelCanvas <span class="op">=</span> cv2.polylines(idLabelCanvas,[pts],<span class="va">True</span>,(<span class="dv">255</span>,<span class="dv">0</span>,<span class="dv">0</span>),<span class="dv">2</span>, cv2.LINE_AA)</span>
                  <span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a>                idLabelCanvas <span class="op">=</span> cv2.fillPoly(idLabelCanvas,[pts],(<span class="dv">255</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
                  <span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a>                canvas2idLabelCanvas<span class="op">=</span> cv2.putText(idLabelCanvas,<span class="st">&#39;ID: &#39;</span> <span class="op">+</span> <span class="bu">str</span>(ID), org <span class="op">=</span> (cx <span class="op">+</span> <span class="dv">20</span>, cy <span class="op">-</span> <span class="dv">20</span>),</span>
                  <span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>                            fontFace <span class="op">=</span> cv2.FONT_HERSHEY_PLAIN, fontScale <span class="op">=</span> <span class="dv">2</span>, color <span class="op">=</span> (<span class="dv">0</span>,<span class="dv">255</span>,<span class="dv">255</span>), thickness <span class="op">=</span> <span class="dv">3</span>,lineType <span class="op">=</span> <span class="dv">1</span>)</span>
                  <span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>        </span>
                  <span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a>        Contours, _ <span class="op">=</span> cv2.findContours(contour_mask, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)</span>
                  <span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ctrIdx <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(Contours)):</span>
                  <span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> cv2.contourArea(Contours[ctrIdx]) <span class="op">&gt;</span> <span class="dv">1400</span>:</span>
                  <span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>                idCounter <span class="op">+=</span> <span class="dv">1</span></span>
                  <span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>                ID <span class="op">=</span> idCounter</span>
                  <span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>                color <span class="op">=</span> (random.randint(<span class="dv">0</span>, <span class="dv">255</span>), random.randint(<span class="dv">0</span>, <span class="dv">255</span>), random.randint(<span class="dv">0</span>, <span class="dv">255</span>))</span>
                  <span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>                oneCarMask <span class="op">=</span> np.zeros_like(contour_mask)</span>
                  <span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>                oneCarMask <span class="op">=</span> cv2.drawContours(oneCarMask, Contours, ctrIdx, (<span class="dv">255</span>, <span class="dv">255</span>, <span class="dv">255</span>), <span class="op">-</span><span class="dv">1</span>)</span>
                  <span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a>                carFeatures <span class="op">=</span> cv2.goodFeaturesToTrack(F0_gray, mask <span class="op">=</span> oneCarMask, <span class="op">**</span>feature_params)</span>
                  <span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>                cars.append([ID,color,carFeatures])</span>
                  <span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>                    </span>
                  <span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># visualize the results</span></span>
                  <span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>        trackingPointCanvas <span class="op">=</span> np.uint8(trackingPointCanvas<span class="op">*</span><span class="fl">0.99</span>) <span class="co"># Fading out older points</span></span>
                  <span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>        trackingPointCanvas <span class="op">=</span> cv2.GaussianBlur(trackingPointCanvas, (<span class="dv">5</span>,<span class="dv">5</span>), <span class="dv">0</span>) <span class="co"># Blurring trails</span></span>
                  <span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>        final <span class="op">=</span> cv2.addWeighted(F1, <span class="dv">1</span>, trackingPointCanvas, <span class="fl">0.5</span>, <span class="dv">0</span>) <span class="co"># Blending the Images</span></span>
                  <span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>        final <span class="op">=</span> cv2.add(final, idLabelCanvas)</span>
                  <span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>        cv2.putText(final,<span class="st">&#39;Tracking &#39;</span> <span class="op">+</span> <span class="bu">str</span>(<span class="bu">len</span>(cars)) <span class="op">+</span> <span class="st">&#39; Vehicles&#39;</span>, org <span class="op">=</span> (<span class="dv">80</span>,<span class="dv">80</span>),</span>
                  <span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>                   fontFace <span class="op">=</span> cv2.FONT_HERSHEY_PLAIN,</span>
                  <span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a>                   fontScale <span class="op">=</span> <span class="dv">3</span>,</span>
                  <span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>                   color <span class="op">=</span> (<span class="dv">0</span>,<span class="dv">255</span>,<span class="dv">255</span>),</span>
                  <span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a>                   thickness <span class="op">=</span> <span class="dv">3</span>,</span>
                  <span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>                   lineType <span class="op">=</span> <span class="dv">1</span>) </span>
                  <span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>        cv2.imshow(<span class="st">&#39;ctr&#39;</span>,contour_mask)</span>
                  <span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>        cv2.imshow(<span class="st">&#39;final&#39;</span>,final)</span>
                  <span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>        out.write(final)</span>
                  <span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a>            </span>
                  <span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Updating the previous frame</span></span>
                  <span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>        F0_gray <span class="op">=</span> F1_gray</span>
                  <span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> cv2.waitKey(<span class="dv">1</span>) <span class="op">&amp;</span> <span class="bn">0xff</span></span>
                  <span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="op">==</span> <span class="dv">27</span>:</span>
                  <span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
                  <span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># No more frames to read</span></span>
                  <span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
                  <span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a></span>
                  <span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a>cv2.destroyAllWindows()</span>
                  <span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a>cap.release()</span>
                  <span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a>out.release()</span>
                  <span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a>cv2.waitKey(<span class="dv">1</span>)</span></code></pre>
                        </div>
                        <div class="output execute_result" data-execution_count="20">
                            <pre><code>-1</code></pre>
                        </div>
                    </div>
                    <div class="cell code">
                        <div class="sourceCode" id="cb35">
                            <pre class="sourceCode python"><code class="sourceCode python"></code></pre>
                        </div>
                    </div>
                </body>
            </div>

        </div>

        <!-- Scripts -->
        <script src="assets/js/jquery.min.js"></script>
        <script src="assets/js/browser.min.js"></script>
        <script src="assets/js/breakpoints.min.js"></script>
        <script src="assets/js/util.js"></script>
        <script src="assets/js/main.js"></script>



</html>